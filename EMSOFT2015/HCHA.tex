\subsection{Communicating hierarchical hybrid \\automata}
\label{HCHA}
{\it As noted in the introduction, the execution of an autonomous plan involves many levels of abstraction. The verification must cover all these levels.}

{\it We use the formalism of communicating hierarchical hybrid automata (CHHA) to model agents in the scenario. }
\todo[inline]{Charon: make sure that the HCHA is implemented in Charon (or something close)}
\todo[inline]{Ptolemy}
We start with a few basic elements:
an agent (of one of the types described above) has a state vector $x \in \reals^n$.
(Different agents may have different dimensions; when more than one agent is involved, we will subscript the dimension $n_i$.)
The state includes all information of relevance to the system designers: for the ego vehicle, this will typically include position and velocity, but also fuel combustion rate and wall-wetting effects if needed.
For a traffic light (which is an agent of type \texttt{trafficSignage}), the state might include the current active light and a clock that measures the delay between light switches.
An agent is modeled as a \emph{communicating} hybrid automaton.

\begin{defn}[Communicating hybrid automaton]
A (driven) \textbf{communicating hybrid automaton} (CHA) with inputs in $\inpSet$ 
is a tuple $\Hc = (X, Q, E, Inv, F, G, Re, \funcOut, C)$
where $X \subseteq \Re^n$ is the state space of the system, 
$Q$ is the set of control modes (a.k.a `locations'), 
$E \subseteq Q \times Q$ is the set of control switches, 
$Inv : Q \rightarrow 2^X$ assigns an invariant set of the dynamics to each location, 
$F : Q \times X \times \inpSet \rightarrow \Re^n$ defines the time derivative of the continuous part of the state, 
$G : E \times X \rightarrow 2^X$ is the guard condition that enables a control switch $e \in E$,
$Re : X \times E \rightarrow X \times Q$ is a reset map that resets the state with every control switch,
$\funcOut: \reals^n \rightarrow \reals^p$ is an output function,
and $C = \{c_1,\ldots,c_p\}$ is a set of $p$ listening conditions (defined below)
  
Let $H = Q \times X$ denote the state space of the hybrid automaton $\Hc$.
	\end{defn}
	
\todo[inline]{execution semantics}
%Formally, the semantics of a hybrid automaton are given in terms of generalized or timed transition systems \cite{Henzinger96}.
%For the purposes of this paper, we define a {\it trajectory} $\hstraj_{h_0}$ starting from a point $h_0 \in H$ to be a function $\hstraj_{h_0} : \Re_+ \times \Ne \rightarrow H$
%defined by: $\hstraj_{h_0}(t) = (\mode(t,j), \sttraj_{h_0}(t,j))$, where $\mode(t,j)$ is the location at time $(t,j)$, and $\sttraj_{h_0}(t,j)$ is the continuous state at time $(t,j)$.
	
The differential equations in each mode of the HA model the continuous-time closed-loop behavior of the low-level controlled systems, i.e., the mechanical systems of the car such as the powertrain,
The modes themselves model the application of different control laws. 
The input $\inpPt \in \inpSet$ is an analytical artifact that is applicable only to the autonomous agent.
It models external disturbances that are not due to other agents, e.g., the effect of weather conditions like low visibility. 

Without the communication conditions $C$, a CHA is simply a hybrid automaton.
To model how agents perceive each other at a high level, we consider that an agent will broadcast certain information about its state that other agents can occasionally listen to.
Formally, associated to an agent is a function $f:\reals^n \rightarrow \reals^p$.
At each time instant $(t,j)$, the agent broadcasts $f(x(t,j))$.
Not every other agent can listen to the broadcast.
Given two agents $A_1$ and $A_2$ in the same scenario, with agent $A_1$ broadcasting $y = f(x)$, agent $A_2$ must meet certain conditions on its state to be able to receive (and act upon) the information broadcast by $A_1$.
Specifically, if $y(t,j) = (y_1,\ldots,y_p)$, then to listen to $y_k$, $k=1,\ldots,p$, the state $x_2(t,j)$ of $A_2$ must satisfy some boolean `listening' condition $c(x_2,k)$.
For example, every agent $A_1$ must transmit its visual appearance - it can't become invisible.
For another agent $A_2$ to perceive it, $A_2$ must be close enough and with a line of sight to $A_1$. 
Then 
\[c(x_2,k) \equiv ||x_1 - x_2 || \leq d \land \forall i\neq 1,2, A_1,A_2,A_i \text{ not aligned}\]
\todo[inline]{In the future, model the effect of sensory overload to study acquisition of info. I.e. subscribing to a channel has a control cost.}
This model of communication subsumes traditional models of processes that communicate via shared variables, like that in \todo[inline]{insert insup lee citation}, and generalizes it by imposing conditions under which communication is possible, rather than allow communication at all times.

As a matter of practicality, CHAs will be represented as \emph{hierarchical} CHAs. 
A hierarchical CHA is a CHA with a chain of partitions defined on its mode set $Q$.
\begin{defn}[Hierarchical CHA]
	A \textbf{hierarchical CHA} (HCHA) is a tuple $(\Hc, \Pc)$ where $\Hc$ is a CHA, and $\Pc = \{P_1,P_2,\ldots,P_a\}$ is an ascending chain of partitions of the set $Q$, that is:
	\begin{itemize}
		\item For every $i =1,\ldots,a$, $P_i \subset 2^Q$ partitions $Q$: $[q] \cap [q'] = \emptyset$ for all $[q],[q'] \in P_i$ and $\cup_{q\in Q}[q] = Q$
		\item For all $i<a$, for all $[q]\in P_i, \exists [q'] \in P_{i+1}$ s.t. $[q] \subset [q']$ 
	\end{itemize}
\end{defn}

{\it The behaviors of the non-ego agents are described, at the lowest level, via a possibly non-deterministic sequence of reach sets.}

{\it HCHA can be translated to various other formalisms. We consider the case of timed automata, and of ODEs (i.e. dynamical systems).}

\begin{exmp}[Lane change continued]
	We model the lane change scenario using HCHA as follows
	\todo[inline]{must show how the 4 agent types are modeled with this}
	\end{exmp}
